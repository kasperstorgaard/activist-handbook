<link rel="import" href="../stores/root-store.html">

<script>
  (() => {
    const Stores = window.Stores || (window.Stores = {});

    const StoreMixin = T => class extends T {
      constructor() {
        super();

        this._dispatch = Stores.Root.dispatch.bind(Stores.Root);
      }

      connectedCallback() {
        super.connectedCallback();

        if (!('_mapStateToProps' in this)) {
          return;
        }

        this.__handleStoreChange = () => {
          const state = Stores.Root.getState();
          const props = this._mapStateToProps(state);

          if (typeof props !== 'object') {
            throw new Error('ReduxStore: method `_mapStateToProps()` must return an object.');
          }

          Object.assign(this, props);
        };

        Stores.Root.subscribe(this.__handleStoreChange);

        // Initialize the state.
        this.__handleStoreChange();
      }

      disconnectedCallback() {
        super.disconnectedCallback();

        if (this.__handleStoreChange) {
          Stores.Root.unsubscribe(this.__handleStoreChange);
        }
      }
    }

    Stores.Mixin = StoreMixin;
  })();
</script>