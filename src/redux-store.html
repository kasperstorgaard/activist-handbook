<link rel="import" href="../libs/redux.html">

<script>
  (() => {
    const initialState = {
      friends: []
    };

    const reducer = (state, action) => {
      if (!state) {
        return initialState;
      }

      switch (action.type) {
        case 'ADD_FRIEND':
          const friends = state.friends.concat([action.friend]);
          return Object.assign({}, state, { friends });
      }
    }

    const store = Redux.createStore(reducer);

    window.StoreMixin = T => class extends T {
      connectedCallback() {
        super.connectedCallback();

        this._dispatch = store.dispatch.bind(store);

        if (!('_mapStateToProps' in this)) {
          return;
        }

        this.__handleStoreChange = () => {
          const state = store.getState();
          const props = this._mapStateToProps(state);

          if (typeof props !== 'object') {
            throw new Error('ReduxStore: method `_mapStateToProps()` must return an object.');
          }

          Object.assign(this, props);
        };

        store.subscribe(this.__handleStoreChange);
      }

      disconnectedCallback() {
        super.disconnectedCallback();

        if (this.__handleStoreChange) {
          store.unsubscribe(this.__handleStoreChange);
        }
      }
    }
  })();
</script>